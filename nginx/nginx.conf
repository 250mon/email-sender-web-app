events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # Common proxy headers (DRY)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    
    upstream backend {
        server backend-nginx:8000;
    }
    
    upstream frontend {
        server frontend-nginx:80;
    }

    upstream main-service {
        server localhost:8000;
    }
    
    server {
        listen 80;
        server_name _;
        
        # Common proxy settings for all locations
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Serve frontend at /email_sender
        location /email_sender/ {
            # Remove /email_sender prefix and proxy to frontend
            # rewrite ^/email_sender/(.*) /$1 break;
            proxy_pass http://frontend/;
        }
        
        # Handle /email_sender without trailing slash
        location = /email_sender {
            proxy_pass http://frontend/;
        }
        
        # All React assets will now be under /email_sender/ due to PUBLIC_URL
        # No need for separate asset handling
        
        # Serve backend API at /email_sender/api (with trailing slash)
        location /email_sender/api/ {
            # Remove /email_sender/api prefix, forward the rest
            # rewrite ^/email_sender/api/(.*) /api/$1 break;
            proxy_pass http://backend/api/;
        }
        
        # Redirect root to /email_sender
        # location = / {
        #     return 301 /email_sender/;
        # }
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
